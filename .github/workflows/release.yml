name: "Release"

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release_please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      upload_url: ${{ steps.release.outputs.upload_url }}
    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: rust
          package-name: minimize-git-diff-llm

  build_artifacts:
    name: Build Artifacts (reusable)
    needs: release_please
    if: ${{ needs.release_please.outputs.release_created == 'true' }}
    uses: ./.github/workflows/build-artifacts.yml
    with:
      tag_name: ${{ needs.release_please.outputs.tag_name }}
      bin_name: minimize-git-diff-llm

  update_docs:
    name: Update Documentation
    needs: release_please
    if: ${{ needs.release_please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update README with latest release info
        shell: bash
        run: |
          version="${{ needs.release_please.outputs.tag_name }}"
          version="${version#v}" # strip leading v if present

          echo "📝 Updating README with latest release info..."

          # Update installation section in README
          sed -i.bak "s|curl -fsSL https://raw.githubusercontent.com/towry/minimize-git-diff-llm/.*/install.sh|curl -fsSL https://raw.githubusercontent.com/towry/minimize-git-diff-llm/v${version}/install.sh|g" README.md

          # Create a comprehensive release section
          cat >> README.md << 'README_EOF'

          ## 🚀 Latest Release

          **Version**: vVERSION

          ### Quick Install
          ```bash
          curl -fsSL https://raw.githubusercontent.com/towry/minimize-git-diff-llm/vVERSION/install.sh | bash
          ```

          ### Manual Download
          Download from [GitHub Releases](https://github.com/towry/minimize-git-diff-llm/releases/latest):
          - Linux (x86_64)
          - macOS (Apple Silicon)
          - macOS (Intel)

          README_EOF

          # Replace placeholder with actual version
          sed -i.bak "s/vVERSION/v${version}/g" README.md

          # Remove backup file
          rm -f README.md.bak

      - name: Commit documentation updates
        shell: bash
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          if git diff --staged --quiet; then
            echo "No documentation changes to commit"
          else
            git commit -m "docs: update installation links for v${{ needs.release_please.outputs.tag_name }}"
            git push
          fi

      - name: Create release summary
        shell: bash
        run: |
          version="${{ needs.release_please.outputs.tag_name }}"
          version="${version#v}" # strip leading v if present

          echo "## 🎉 Release v${version} Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📦 What's included:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Pre-built binaries for Linux, macOS ARM, and macOS Intel" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Automatic installation script with checksum verification" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Updated documentation and installation instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 Installation Options:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Quick install** (recommended):" >> $GITHUB_STEP_SUMMARY
          echo '   ```bash' >> $GITHUB_STEP_SUMMARY
          echo "   curl -fsSL https://raw.githubusercontent.com/towry/minimize-git-diff-llm/v${version}/install.sh | bash" >> $GITHUB_STEP_SUMMARY
          echo '   ```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Manual download** from [GitHub Releases](https://github.com/towry/minimize-git-diff-llm/releases/latest)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🧪 Usage:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Basic usage" >> $GITHUB_STEP_SUMMARY
          echo "git diff | minimize-git-diff-llm" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# With staged changes" >> $GITHUB_STEP_SUMMARY
          echo "git diff --cached | minimize-git-diff-llm" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY