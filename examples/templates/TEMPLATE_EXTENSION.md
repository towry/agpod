# Template Extension Examples

This directory demonstrates how to use Jinja2 template inheritance with `{% extends %}` in agpod kiro.

## What is Template Extension?

Template extension allows you to create a base template with common structure and then extend it in specific templates. This follows the DRY (Don't Repeat Yourself) principle and makes template maintenance easier.

## Directory Structure

```
templates/
├── _shared/                    # Shared/base templates (prefix with _ by convention)
│   ├── base_design.md.j2      # Base template for DESIGN.md files
│   └── base_task.md.j2        # Base template for TASK.md files
├── default/                    # Default template (extends base)
│   ├── DESIGN.md.j2           # Extends _shared/base_design.md.j2
│   └── TASK.md.j2             # Extends _shared/base_task.md.j2
├── vue/                        # Vue-specific templates
│   ├── DESIGN.md.j2           # Extends base, customizes for Vue
│   ├── TASK.md.j2             # Extends base, adds Vue-specific tasks
│   └── COMPONENT.md.j2        # Standalone template
└── rust/                       # Rust-specific templates
    ├── DESIGN.md.j2           # Extends base, customizes for Rust
    ├── TASK.md.j2             # Extends base, adds Rust-specific tasks
    └── IMPL.md.j2             # Standalone template
```

## How Template Extension Works

### 1. Define a Base Template

`_shared/base_design.md.j2`:
```jinja2
# {% block title %}设计方案：{{ desc }}{% endblock %}

## 元信息
- 分支名：`{{ branch_name }}`
- 创建时间：{{ now }}
- 作者：{{ user }}

{% block content %}
## 背景
（默认内容）
{% endblock %}

{% block footer %}
## 附录
{% endblock %}
```

### 2. Extend the Base Template

`default/DESIGN.md.j2`:
```jinja2
{% extends "_shared/base_design.md.j2" %}

{# You can override any block from the base template #}

{% block content %}
## 背景
（自定义背景内容）

## 目标
（添加新的章节）

## 方案
（添加更多内容）
{% endblock %}
```

### 3. The Result

When rendered, the child template inherits the structure from the base and overrides specific blocks:

```markdown
# 设计方案：实现用户登录

## 元信息
- 分支名：`feature-impl-login-abc123`
- 创建时间：2025-10-14T08:00:00Z
- 作者：developer

## 背景
（自定义背景内容）

## 目标
（添加新的章节）

## 方案
（添加更多内容）

## 附录
```

## Block Overriding Rules

### Complete Override
```jinja2
{% extends "base.md.j2" %}

{% block content %}
完全替换基础模板的 content 块
{% endblock %}
```

### Append to Parent Block
```jinja2
{% extends "base.md.j2" %}

{% block content %}
{{ super() }}  {# Include parent block content #}
额外添加的内容
{% endblock %}
```

### Multiple Level Inheritance
```jinja2
{# base.md.j2 #}
{% block header %}Base{% endblock %}

{# intermediate.md.j2 #}
{% extends "base.md.j2" %}
{% block header %}{{ super() }} > Intermediate{% endblock %}

{# final.md.j2 #}
{% extends "intermediate.md.j2" %}
{% block header %}{{ super() }} > Final{% endblock %}

{# Result: "Base > Intermediate > Final" #}
```

## Key Concepts

### Blocks
Blocks are sections in the base template that can be overridden:
```jinja2
{% block block_name %}
  default content
{% endblock %}
```

### Super
Use `{{ super() }}` to include the parent block's content:
```jinja2
{% block content %}
{{ super() }}  {# Include parent content #}
Additional content
{% endblock %}
```

### Template Path
The path in `{% extends %}` is relative to the templates directory root:
- `{% extends "_shared/base.md.j2" %}` - Correct
- `{% extends "../_shared/base.md.j2" %}` - Also works but not recommended

## Practical Examples

### Example 1: Consistent Header Across All Templates

**Base Template** (`_shared/base_design.md.j2`):
```jinja2
# {% block title %}{{ desc }}{% endblock %}

## Metadata
- Branch: `{{ branch_name }}`
- Created: {{ now }}
- Author: {{ user }}
{% if git.repo_root %}
- Repo: {{ git.repo_root }}
{% endif %}

---

{% block content %}{% endblock %}

---

{% block footer %}
Generated by agpod kiro
{% endblock %}
```

**Child Template** (`rust/DESIGN.md.j2`):
```jinja2
{% extends "_shared/base_design.md.j2" %}

{% block title %}Rust Module: {{ desc }}{% endblock %}

{% block content %}
## Module Design
...Rust-specific content...
{% endblock %}
```

### Example 2: Common Task Workflow

**Base Template** (`_shared/base_task.md.j2`):
```jinja2
# Task: {{ branch_name }}

## Standard Workflow
{% block workflow %}
- [ ] Requirements review
- [ ] Implementation
- [ ] Testing
- [ ] Code review
- [ ] Deployment
{% endblock %}

{% block extra_tasks %}
{# Child templates can add extra sections #}
{% endblock %}
```

**Vue Child Template** (`vue/TASK.md.j2`):
```jinja2
{% extends "_shared/base_task.md.j2" %}

{% block workflow %}
{{ super() }}  {# Keep standard workflow #}
- [ ] Update Storybook
- [ ] Visual regression tests
{% endblock %}

{% block extra_tasks %}
## Vue-Specific Checks
- [ ] Component props validation
- [ ] Event emission tests
- [ ] Slots functionality
{% endblock %}
```

## Benefits of Template Extension

1. **DRY Principle**: Write common structure once, reuse everywhere
2. **Consistency**: All templates share the same basic structure
3. **Maintainability**: Update base template affects all children
4. **Flexibility**: Each template can customize specific sections
5. **Organization**: Clear separation between shared and specific content

## Best Practices

1. **Use `_shared` prefix**: Indicate that templates are meant to be extended, not used directly
2. **Define clear blocks**: Give blocks descriptive names (content, header, footer, etc.)
3. **Document blocks**: Use comments to explain what each block is for
4. **Keep base templates simple**: Don't put too much logic in base templates
5. **Test inheritance**: Verify that templates render correctly after changes

## Testing Template Extension

You can test template extension by creating a draft:

```bash
# Test default template (extends base)
agpod kiro pr-new --desc "测试模板继承" --template default

# Test vue template (extends base with Vue customizations)
agpod kiro pr-new --desc "测试 Vue 组件" --template vue

# Test rust template (extends base with Rust customizations)
agpod kiro pr-new --desc "测试 Rust 模块" --template rust
```

Then check the generated DESIGN.md and TASK.md files to see how the base template structure is preserved while specific content is customized.

## Advanced: Creating Your Own Base Templates

You can create your own base templates for your organization:

1. Create a company-wide base template:
```bash
mkdir -p ~/.config/agpod/templates/_company
```

2. Define your base template:
```jinja2
{# _company/base.md.j2 #}
# {{ desc }}

**Company Standard Header**
- Project: {{ config.project_name }}
- Team: {{ config.team_name }}

{% block content %}{% endblock %}

**Company Standard Footer**
- Compliance: ✓
- Security Review: Required
```

3. Extend it in project-specific templates:
```jinja2
{# myproject/DESIGN.md.j2 #}
{% extends "_company/base.md.j2" %}

{% block content %}
Project-specific design content
{% endblock %}
```

## Troubleshooting

**Error: "Template not found"**
- Ensure the base template path is correct relative to templates root
- Check that the base template file exists
- Verify file permissions

**Error: "Block not found"**
- Make sure the block name in child matches the base template
- Check for typos in block names

**Content not showing**
- Verify you're overriding the correct block
- Check if you need `{{ super() }}` to include parent content

## Reference

- [minijinja extends documentation](https://docs.rs/minijinja/latest/minijinja/syntax/index.html#-extends-)
- [Jinja2 Template Inheritance](https://jinja.palletsprojects.com/en/3.1.x/templates/#template-inheritance)
